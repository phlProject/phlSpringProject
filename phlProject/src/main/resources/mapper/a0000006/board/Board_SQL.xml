<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="a0000006/board">
	
	<!-- /****************************** 책 소 개 시작  ******************************/ -->
	
	<!-- 책소개 > 조회 > Count -->
	<select id="bookListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM BSNS_BOARD		BMB
		     LEFT OUTER JOIN BSNS_BOARD_FL	BMBF
		      ON BMB.BSNS_CODE = BMBF.BSNS_CODE
		     AND BMB.BOARD_SN  = BMBF.BOARD_SN
		     AND BMBF.USE_YN = 'Y'
		WHERE 1=1
		  AND BMB.USE_YN = 'Y'
		  AND BMB.BSNS_CODE = #{bsnsCode}
		  AND BMB.BOARD_GBN_CD = #{boardGbnCd}
		  <if test="searchSelect != '' or searchSelect != null">
		  	<choose>
			 	<when test='searchSelect == "searchSubject"'>
			 		AND BMB.SUBJECT LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchContent"'>
			 		AND BMB.CONTENTS LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchSubCon"'>
			 		AND CONCAT(BMB.SUBJECT,BMB.CONTENTS) LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
		  	</choose>
		  </if>
	</select>
	
	<!-- 책소개 > 조회  -->
	<select id="bookList" parameterType="hashmap" resultType="hashmap">
		SELECT BMB.BSNS_CODE
			  ,BMB.BOARD_SN
			  ,BMB.BOARD_GBN_CD
			  ,BMB.SUBJECT
			  ,BMB.CONTENTS
			  ,BMB.HIT_COUNT
			  ,BMB.LIKE_COUNT
			  ,BMBF.BOARD_FL_SN
			  ,BMBF.ORIGIN_FL_NM
			  ,BMBF.FL_NM
			  ,BMBF.FL_PATH
		FROM BSNS_BOARD		BMB
		     LEFT OUTER JOIN BSNS_BOARD_FL	BMBF
		      ON BMB.BSNS_CODE = BMBF.BSNS_CODE
		     AND BMB.BOARD_SN  = BMBF.BOARD_SN
		     AND BMBF.USE_YN = 'Y'
		WHERE 1=1
		  AND BMB.USE_YN = 'Y'
		  AND BMB.BSNS_CODE = #{bsnsCode}
		  AND BMB.BOARD_GBN_CD = #{boardGbnCd}
		  <if test="searchSelect != '' or searchSelect != null">
		  	<choose>
			 	<when test='searchSelect == "searchSubject"'>
			 		AND BMB.SUBJECT LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchContent"'>
			 		AND BMB.CONTENTS LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchSubCon"'>
			 		AND CONCAT(BMB.SUBJECT,BMB.CONTENTS) LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
		  	</choose>
		  </if>
		ORDER BY BMB.BOARD_SN DESC
		LIMIT #{limitFirst}, #{limitSecond}
	</select>

	<!-- 책소개 > 상세  폼 -->
	<select id="bookView" parameterType="hashmap" resultType="hashmap">
	SELECT BMB.BSNS_CODE
			  ,BMB.BOARD_SN
			  ,BMB.BOARD_GBN_CD
			  ,BMB.SUBJECT
			  ,BMB.CONTENTS
			  ,BMB.HIT_COUNT
			  ,BMB.LIKE_COUNT
			  ,BMBF.BOARD_FL_SN
			  ,BMBF.ORIGIN_FL_NM
			  ,BMBF.FL_NM
			  ,BMBF.FL_PATH
			  ,BMBFLH.MEM_ID
		  	  ,BMBFLH.LIKE_YN
		FROM BSNS_BOARD		BMB
		     LEFT OUTER JOIN BSNS_BOARD_FL	BMBF
		      ON BMB.BSNS_CODE = BMBF.BSNS_CODE
		     AND BMB.BOARD_SN  = BMBF.BOARD_SN
		     AND BMBF.USE_YN = 'Y'
		     LEFT OUTER JOIN BSNS_BOARD_LIKE BMBFLH
	      	   ON BMB.BSNS_CODE = BMBFLH.BSNS_CODE
	     	 AND BMB.BOARD_SN  = BMBFLH.BOARD_SN
	     	 AND BMBFLH.MEM_ID = #{sessionId}
		WHERE 1=1
		  AND BMB.USE_YN = 'Y'
		  AND BMB.BSNS_CODE = #{bsnsCode}
		  AND BMB.BOARD_SN = #{boardSn}
	</select>	

	<!-- 책소개 > 등록 -->
	<insert id="insertBook" parameterType="hashmap">
			INSERT INTO BSNS_BOARD(
				 BSNS_CODE
				,BOARD_GBN_CD
				,SUBJECT
				,CONTENTS
				,REG_DT
				,REG_ID
			)VALUES(
				 #{bsnsCode}
				,#{boardGbnCd}
				,#{subject}
				,#{editor}
				,now()
				,'aa'
			)
	</insert>
	
	<!-- 책소개 > 수정 -->
	<update id="updateBook"  parameterType="hashmap">
		UPDATE BSNS_BOARD
		   SET SUBJECT = #{subject}
		      ,CONTENTS = #{editor}
		      ,MOD_DT = now()
		      ,MOD_ID = 'aa'
		 WHERE 1=1
		   AND BSNS_CODE = #{bsnsCode}
		   AND BOARD_SN  = #{boardSn}
	</update>
	
	<!-- 책소개 > 삭제 -->
	<update id="deleteBook"  parameterType="hashmap">
		UPDATE BSNS_BOARD
		   SET USE_YN = 'N'
		      ,MOD_DT = now()
		      ,MOD_ID = 'aa'
		 WHERE 1=1
		   AND BSNS_CODE = #{bsnsCode}
		   AND BOARD_SN  = #{boardSn}
	</update>
	
	<!-- 책소개 > 좋아요 Count -->
	<update id="bookLikeCount" parameterType="hashmap">
		UPDATE BSNS_BOARD
		SET 
			<if test='saveLike eq "Y"'>	LIKE_COUNT = LIKE_COUNT + 1 </if>
			<if test='saveLike eq "N"'>	LIKE_COUNT = LIKE_COUNT - 1 </if>
		WHERE 1=1
		  AND BSNS_CODE = #{bsnsCode}
		  AND BOARD_SN  = #{boardSn}
	</update>
	
	<!-- 책소개 > 좋아요 등록/수정 -->
	<insert id="bookLikeHistory" parameterType="hashmap">
		INSERT INTO BSNS_BOARD_LIKE(BSNS_CODE, BOARD_SN, MEM_ID, LIKE_YN, REG_ID, REG_DT, MOD_ID, MOD_DT)
		VALUES(#{bsnsCode}, #{boardSn}, #{sessionId}, #{saveLike}, #{sessionId}, now(), #{sessionId}, now() )
		ON DUPLICATE KEY 
		UPDATE 	LIKE_YN = #{saveLike},
				MOD_ID 	= #{sessionId},
				MOD_DT	= now()
	</insert>
	
	<!-- /****************************** 책 소 개 종료  ******************************/ -->
	
	<!-- /****************************** 간 행 물 시작  ******************************/ -->
	
	<!-- 간행물 > 조회 > Count -->
	<select id="publiListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM BSNS_BOARD		BMB
		     LEFT OUTER JOIN BSNS_BOARD_FL	BMBF
		      ON BMB.BSNS_CODE = BMBF.BSNS_CODE
		     AND BMB.BOARD_SN  = BMBF.BOARD_SN
		     AND BMBF.USE_YN = 'Y'
		WHERE 1=1
		  AND BMB.USE_YN = 'Y'
		  AND BMB.BSNS_CODE = #{bsnsCode}
		  AND BMB.BOARD_GBN_CD = #{boardGbnCd}
		  <if test="searchSelect != '' or searchSelect != null">
		  	<choose>
			 	<when test='searchSelect == "searchSubject"'>
			 		AND BMB.SUBJECT LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchContent"'>
			 		AND BMB.CONTENTS LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchSubCon"'>
			 		AND CONCAT(BMB.SUBJECT,BMB.CONTENTS) LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
		  	</choose>
		  </if>
	</select>
	
	<!-- 간행물 > 조회  -->
	<select id="publiList" parameterType="hashmap" resultType="hashmap">
		SELECT BMB.BSNS_CODE
			  ,BMB.BOARD_SN
			  ,BMB.BOARD_GBN_CD
			  ,BMB.SUBJECT
			  ,BMB.CONTENTS
			  ,BMB.HIT_COUNT
			  ,BMB.LIKE_COUNT
			  ,BMBF.BOARD_FL_SN
			  ,BMBF.ORIGIN_FL_NM
			  ,BMBF.FL_NM
			  ,BMBF.FL_PATH
		FROM BSNS_BOARD		BMB
		     LEFT OUTER JOIN BSNS_BOARD_FL	BMBF
		      ON BMB.BSNS_CODE = BMBF.BSNS_CODE
		     AND BMB.BOARD_SN  = BMBF.BOARD_SN
		     AND BMBF.USE_YN = 'Y'
		WHERE 1=1
		  AND BMB.USE_YN = 'Y'
		  AND BMB.BSNS_CODE = #{bsnsCode}
		  AND BMB.BOARD_GBN_CD = #{boardGbnCd}
		  <if test="searchSelect != '' or searchSelect != null">
		  	<choose>
			 	<when test='searchSelect == "searchSubject"'>
			 		AND BMB.SUBJECT LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchContent"'>
			 		AND BMB.CONTENTS LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchSubCon"'>
			 		AND CONCAT(BMB.SUBJECT,BMB.CONTENTS) LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
		  	</choose>
		  </if>
		ORDER BY BMB.BOARD_SN DESC
		LIMIT #{limitFirst}, #{limitSecond}
	</select>
	
	<!-- 간행물 > 상세 폼  -->
	<select id="publiView" parameterType="hashmap" resultType="hashmap">
	SELECT BMB.BSNS_CODE
			  ,BMB.BOARD_SN
			  ,BMB.BOARD_GBN_CD
			  ,BMB.SUBJECT
			  ,BMB.CONTENTS
			  ,BMB.HIT_COUNT
			  ,BMB.LIKE_COUNT
			  ,BMBF.BOARD_FL_SN
			  ,BMBF.ORIGIN_FL_NM
			  ,BMBF.FL_NM
			  ,BMBF.FL_PATH
		FROM BSNS_BOARD		BMB
		     LEFT OUTER JOIN BSNS_BOARD_FL	BMBF
		      ON BMB.BSNS_CODE = BMBF.BSNS_CODE
		     AND BMB.BOARD_SN  = BMBF.BOARD_SN
		     AND BMBF.USE_YN = 'Y'
		WHERE 1=1
		  AND BMB.USE_YN = 'Y'
		  AND BMB.BSNS_CODE = #{bsnsCode}
		  AND BMB.BOARD_SN = #{boardSn}
	</select>	
	
	<!--  간행물 > 등록 --> 
	<insert id="insertPubli" parameterType="hashmap">
		INSERT INTO BSNS_BOARD(
				 BSNS_CODE
				,BOARD_GBN_CD
				,SUBJECT
				,CONTENTS
				,REG_DT
				,REG_ID
		)VALUES(
				 #{bsnsCode}
				,#{boardGbnCd}
				,#{subject}
				,#{editor}
				,now()
				,'aa'
				<!--,#{sessionId}-->
			)
	</insert>
	
	<!-- 간행물 > 수정 -->
	<update id="updatePubli"  parameterType="hashmap">
		UPDATE BSNS_BOARD
		   SET SUBJECT = #{subject}
		      ,CONTENTS = #{editor}
		      ,MOD_DT = now()
		      ,MOD_ID = 'aa'
		 WHERE 1=1
		   AND BSNS_CODE = #{bsnsCode}
		   AND BOARD_SN  = #{boardSn}
	</update>
	
	<!-- 간행물 > 삭제 -->
	<update id="deletePubli"  parameterType="hashmap">
		UPDATE BSNS_BOARD
		   SET USE_YN = 'N'
		      ,MOD_DT = now()
		      ,MOD_ID = 'aa'
		 WHERE 1=1
		   AND BSNS_CODE = #{bsnsCode}
		   AND BOARD_SN  = #{boardSn}
	</update>
	
	<!-- /****************************** 간 행 물 종료  ******************************/ -->
	
	
	<!-- /****************************** 게시판 공통 시작  ****************************/ -->
	
	<!-- 게시판 공통 > 일련번호 조회  -->
	<select id="selectboardSn" resultType="java.lang.Integer">
		SELECT LAST_INSERT_ID()
	</select>
	
	<!-- 게시판 공통 > 파일 등록  -->
	<insert id="insertBoardFl"  parameterType="hashmap">
		INSERT INTO BSNS_BOARD_FL(
			 BSNS_CODE
			,BOARD_SN
			,ORIGIN_FL_NM
			,FL_NM
			,FL_PATH
			,REG_DT
			,REG_ID
		)VALUES(
			 #{bsnsCode}
			,#{boardSn}
			,#{originFlNm}
			,#{flNm}
			,#{flPath}
			,now()
			,'aa'
			<!--,#{sessionId}-->
		)
	</insert>
	
	<!-- 게시판 공통 > 파일 수정  -->
	<update id="updateBoardFl"  parameterType="hashmap">
		UPDATE BSNS_BOARD_FL
		   SET ORIGIN_FL_NM = #{originFlNm}
		      ,FL_NM = #{flNm}
		      ,FL_PATH = #{flPath}
		      ,MOD_DT = now()
		      ,MOD_ID = 'aa'
		 WHERE 1=1 
		   AND BSNS_CODE = #{bsnsCode}
		   AND BOARD_SN  = #{boardSn}
		   AND BOARD_FL_SN = #{boardFlSn}
	</update>
	
	<!-- 게시판 공통 > 파일 다운로드 > 조회 -->
	<select id="boardFlList" parameterType="hashmap" resultType="hashmap">
		SELECT BMB.BSNS_CODE
			  ,BMB.BOARD_SN
			  ,BMBF.BOARD_FL_SN
			  ,BMBF.ORIGIN_FL_NM
			  ,BMBF.FL_NM
			  ,BMBF.FL_PATH
		FROM BSNS_BOARD 	BMB
		    ,BSNS_BOARD_FL 	BMBF
		WHERE 1=1
		  AND BMB.BSNS_CODE = BMBF.BSNS_CODE
		  AND BMB.BOARD_SN  = BMBF.BOARD_SN
		  AND BMB.USE_YN = 'Y'
		  AND BMBF.USE_YN = 'Y'
		  AND BMB.BSNS_CODE = #{bsnsCode}
		  AND BMB.BOARD_SN  = #{boardSn}
		  AND BMBF.BOARD_FL_SN = #{boardFlSn}
	</select>
	
	<!-- /****************************** 게시판 공통 종료  ****************************/ -->
	
	
	<select id="visitListCnt" parameterType="hashmap" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM BSNS_BOARD		BMB
		     LEFT OUTER JOIN BSNS_BOARD_FL	BMBF
		      ON BMB.BSNS_CODE = BMBF.BSNS_CODE
		     AND BMB.BOARD_SN  = BMBF.BOARD_SN
		     AND BMBF.USE_YN = 'Y'
		WHERE 1=1
		  AND BMB.USE_YN = 'Y'
		  AND BMB.BSNS_CODE = #{bsnsCode}
		  AND BMB.BOARD_GBN_CD = #{boardGbnCd}
		  <if test="searchSelect != '' or searchSelect != null">
		  	<choose>
		  		<!-- 제목 -->
			 	<when test='searchSelect == "searchSubject"'> 
			 		AND BMB.SUBJECT LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<!-- 내용 -->
			 	<when test='searchSelect == "searchContent"'>
			 		AND BMB.CONTENTS LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<!-- 제목+내용 -->
			 	<when test='searchSelect == "searchSubCon"'>
			 		AND CONCAT(BMB.SUBJECT,BMB.CONTENTS) LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
		  	</choose>
		  </if>
	</select>
	
	<select id="visitList" parameterType="hashmap" resultType="hashmap">
		SELECT VISIT.*
		FROM
		(SELECT BMB.BSNS_CODE
			  ,BMB.BOARD_SN
			  ,BMB.BOARD_GBN_CD
			  ,BMB.SUBJECT
			  ,BMB.CONTENTS
			  ,BMB.HIT_COUNT
			  ,BMB.LIKE_COUNT
			  ,BMB.REG_ID
			  ,@ROWNUM := @ROWNUM + 1 AS ROWNUM
		FROM BSNS_BOARD		BMB
			 ,(SELECT @ROWNUM := 0) R
		WHERE 1=1
		  AND BMB.USE_YN = 'Y'
		  AND BMB.BSNS_CODE = #{bsnsCode}
		  AND BMB.BOARD_GBN_CD = #{boardGbnCd}
		  <if test="searchSelect != '' or searchSelect != null">
		  	<choose>
			 	<when test='searchSelect == "searchSubject"'>
			 		AND BMB.SUBJECT LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchContent"'>
			 		AND BMB.CONTENTS LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
			 	<when test='searchSelect == "searchSubCon"'>
			 		AND CONCAT(BMB.SUBJECT,BMB.CONTENTS) LIKE CONCAT('%',#{searchWord},'%')
			 	</when>
		  	</choose>
		  </if>  
		ORDER BY BMB.BOARD_SN ASC
		) VISIT
		LIMIT #{limitFirst}, #{limitSecond}
	</select>
</mapper>